{"componentChunkName":"component---src-templates-article-js","path":"/posts/time-profiler/","result":{"data":{"markdownRemark":{"id":"c8dc9bd1-8b3f-520b-a8e9-301ea5dcbe92","html":"<p>A new feature I've written in an iOS app (not Adobe Acrobat but something else with an enormous user base) is in its A/B testing phase with a small population on production. Unfortunately, after a few weeks, the experiment result shows that the \"feature enabled\" group members experience a larger application hang time (measured by <code>MXAppResponsivenessMetric.histogrammedApplicationHangTime</code> - <a href=\"https://developer.apple.com/documentation/metrickit/mxappresponsivenessmetric/3295907-histogrammedapplicationhangtime\">click here</a> for more info), so I start doing the most sensible thing for the moment: reproduce the \"hang\", and - since I don't measure time by milliseconds - use the <a href=\"https://augmentedcode.io/2021/05/24/an-overview-of-the-time-profiler-in-instruments/#:~:text=Time%20profiler%20is%20one%20of,when%20the%20information%20is%20aggregated.\">Time Profiler</a> from Xcode Instrument to record the whole process.</p>\n<p>Having spent most of my professional life centering divs and (more recently) tweaking <code>NSLayoutConstraint</code>s to make sure my button occupies the right pixels (how fast? I don't care that much), I am dreadfully amateurish with performance optimization and debugging, and have zero prior experience with the time profiler. From a first-timer's perspective, here's my take on the time profiler:</p>\n<p><strong>It does display all the information I need to debug my stuff... but it's SOOOOOO damn counterintuitive to use!</strong></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/7c3abe641963a45e449fa68a979f85f0/98a4d/severe-hang.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 65.83333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAABYlAAAWJQFJUiTwAAACi0lEQVQ4y31Ty27aQBT1D1SVumkLBAO2AWN7/MbmYYOxsYGEhISmIcqikbpLpf5B+yldddF+5emdIVWSLro4us8598z1WNoUCbJFijLPsMpSLIsMBcWz6QiLeYrVMsPZukS1zCk/Q5ZOqBZj/hfJSPRyWxVzSCwuMBlPMBwOEQ0jOI5DdghnukaQbhBUd7Cza7D8E4L8GnZ6DsYxu4Q928HLdmDJFu5ij+T8HpJhGvBdG81GDU25iY6qoSW30dDHOGnrqJkZ3rMSTXcNxa9Qt0tChZq3Rc1ZC79u5ai5W7yzTyHppgs7THCiGGgqDJrvQi9MdO5ttL4SHiy0vjDIDy7BFv7/IL29/A355iden/7Am90vaBffSYmO8mOJm8MUV3cb7G8LXB2W2B8KQn7EbSny3P9wWDzGJaRXyTf4joEBC9DSTLRUHe22hr5qwWrIGHRDmGSNRhtmvUk4+QeNF75UH31GYKlglglVVaF1u+hqKlqKArndgtzhaENW1KN9Duppqby3I2JupSj0kc0STCcjZKMAxTxBOh0jDj2EnoPAs1/CfULoOlhOIizo/CQKEAcuJNca0PvJqMhQVWtcnG+RE2lEH8c2+jD7Giy9+4RBD4zy3PdtE2s6y/uncYjAsYiQGUS4gGcPcFbusEhn2FQ5KnronDTyHQw9WwzkBxxTF2RmTwFjDPPyAmXGFYZigCBc0RSHinfbGPnUxySOsN9tcbpaoqC/ZzT0wW/CFTNSKAj7tHdmE+E5rWmCEa1OKORX8ojU0nsYugNEHhMxH8TV8LrRU+lrK8JyiFy3A8uyjoSzsbiJIDzuqUuN9FQ0RUDvqkIFV8Prz5XxwXyPFim0HxXmRBgHniD8A1appJhhi/lFAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"severe hang\"\n        title=\"severe hang\"\n        src=\"/static/7c3abe641963a45e449fa68a979f85f0/d9199/severe-hang.png\"\n        srcset=\"/static/7c3abe641963a45e449fa68a979f85f0/8ff5a/severe-hang.png 240w,\n/static/7c3abe641963a45e449fa68a979f85f0/e85cb/severe-hang.png 480w,\n/static/7c3abe641963a45e449fa68a979f85f0/d9199/severe-hang.png 960w,\n/static/7c3abe641963a45e449fa68a979f85f0/07a9c/severe-hang.png 1440w,\n/static/7c3abe641963a45e449fa68a979f85f0/29114/severe-hang.png 1920w,\n/static/7c3abe641963a45e449fa68a979f85f0/98a4d/severe-hang.png 2568w\"\n        sizes=\"(max-width: 960px) 100vw, 960px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>It took two WWDC videos (<a href=\"https://developer.apple.com/videos/play/wwdc2022/10082/\">Track down hangs with Xcode and on-device detection\n</a> and <a href=\"https://developer.apple.com/videos/play/wwdc2021/10258/\">Understand and eliminate hangs from your app\n</a>) and my numerous trials and errors to learn how I should navigate this tool. Here are the \"mistakes\" I've made that have costed me a long time -</p>\n<h4>1. Recording with \"immediate\" recording mode instead of \"deferred\" mode, which is the sole cause for a \"severe hang\" in the profile.</h4>\n<p>The \"severe hang\" doesn't occur when I run the app without my feature so I got panicked thinking that there was \"severe\" issue in my code that I had to fix immediately, and spent a long time to investigate this... until I tried recording my feature again with \"deferred recording mode.\" With the deferred mode, I got a result that made sense (a \"microhang\" which lasted for the duration of time a line of code from my feature executed that made the main thread busy,) and that was when I realized that the \"severe hang\" was most likely a \"severe prolongation of my microhang\" caused by the profiler.</p>\n<h4>2. The call stack in \"Profile\" is ordered by time it takes for each call, not chronical order.</h4>\n<p>It's actually obvious, because the header row for the first column says \"Weight\" in bold. Yet it's so counterintuitive to me because I always think about code by the time and order the get executed. Let's assume the following rows are in the \"Profile\" section</p>\n<pre><code>25ms ⌄ main\n15ms   ⌄ Foo\n10ms   ⌄ Bar\n</code></pre>\n<p>I don't think I'd be the only one who would automatically assume that the code would be written as </p>\n<pre><code>func main() {\n    Foo()\n    Bar()\n}\n</code></pre>\n<p>but no - it's perfectly possible that <code>Bar()</code> is called first.</p>\n<p>And the worst part is that there is no way that you can order them by time! (Yes I know that's doable in \"Samples\" where you can check all the frames by clicking on each backtrace, but without the expandable arrows god it's so hard to read and think!)</p>\n<h4>3. Select a time period, and all calls in the profiler would use it's duration.</h4>\n<p>Let's refer back to the capture for Adobe in the screenshot above. It's telling you that the AdobeReader has executed for 1.81s.</p>\n<p>That's actually not true. That should only be interpreted as \"1.81s out of the period of my choice (in this case it's the duration of the severe hang), AdobeReader is executing.\" If you deselect that time frame and reselect the entire \"Adobe Acrobat Reader\" target instead, you'll see that the time is updated from 1.81s to 2.17s.</p>\n<p>Similarly, if you choose maybe a 2ms time period, every line of code seems to be executing for 2ms, which, of course, doesn't happen.</p>\n<p>Even though I have trouble adapting, I think I can see why it's designed this way. The same, however, cannot be said for the next part...</p>\n<h4>4. Even worse: same when you filter by symbol.</h4>\n<p>According to the time profiler, Adobe Acrobat on mac calls the method <code>[NSScriptSuiteRegistry sharedScriptSuiteRegistry]</code>. This call takes 38ms to execute, while AdobeReader takes 2.17s to run.\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0282992327c4d22a324b5f01d59e4201/236d7/profiler-noinputfilter.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 47.08333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB1UlEQVQoz4WQXYvTQBiF44U/QARBQVA3tmkz+Zo0H813mqRtktpNa7ftiriioCsIgtf+PO8VXPHnHN8Mi3oh7MUz77wwczjnSHf3X3Hv/S/cf3eFO29+4PaL77h1/IYHlz/x5OMVHh07DPYM8sEmOOQzC/LWJKx/+LtLvP4ALd5j4HWQ3Q5DfwOFGE63MOINmGaBjUfQGIOu3Yw0UR9DGzxEHliYJw4cTUaVugj1ARJXR7ssEQceDEai4yH0G5A0dQRuaEjjEOUsg8lUMOKiSdAWKeZVgTT04U0sONyAy00hrI0G/0XqjzwOsChzFFlMgmPoygna80uEUYI88pEEJGibYMpTgTo8uUa+3uU/d8nSVCH2vFujWVZwbYscj/Hq4hMCP6TIFV6eH7A5XaGelyjzhJya8CdcTG4wTCyD0EUtUr/MsgTdeoUiTzF1bXBu48vbGHXuoGla7LYdDmc7HPc7rNsG61WDtl6I93kai5lEAXzHhtRbdUh9UWSiK4spUBUFn19PUcUm1ZChpCpO2xrPSKSeF2gXFZbVTLgvyUwWTalbAza5lfrLlJTzJKKIHnTqUO17LUoYugaHKojDALM0EnFD30HoOYjEnNBfLuL3OlxX8RuPTC5i5iRw+wAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"sharedScriptSuiteRegistry no filter\"\n        title=\"sharedScriptSuiteRegistry no filter\"\n        src=\"/static/0282992327c4d22a324b5f01d59e4201/d9199/profiler-noinputfilter.png\"\n        srcset=\"/static/0282992327c4d22a324b5f01d59e4201/8ff5a/profiler-noinputfilter.png 240w,\n/static/0282992327c4d22a324b5f01d59e4201/e85cb/profiler-noinputfilter.png 480w,\n/static/0282992327c4d22a324b5f01d59e4201/d9199/profiler-noinputfilter.png 960w,\n/static/0282992327c4d22a324b5f01d59e4201/07a9c/profiler-noinputfilter.png 1440w,\n/static/0282992327c4d22a324b5f01d59e4201/236d7/profiler-noinputfilter.png 1486w\"\n        sizes=\"(max-width: 960px) 100vw, 960px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>That is, until you put an input filter...\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/d3c22eefa59f8ba3aa2db53a76440dd8/b1ffc/profiler-inputfilter.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 47.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB20lEQVQoz42S646bMBCFeZOqm0AI5hZuBgwBAiXknibtZqtskqrVPkHfX6e2s6zSf/3x6Yxle2Z8PMr5csH1esXr6wW73Q5t2+L08oK3329g30sMvhrQDhbUow3tyHVnQt0SjvkA+VClrkoUeQaWxMhYCpbGKKYZVl2HMPOhUx1mYoIk5E7MoQ9K/10rlq4ijXwwGmBiGaiLDIFrwyE6Sp6c+T5cXYc3HmPyHyiBa/EkObI4hGcTeDxZR120SYBmVmLKKIKJBTIawhqrH5gC/Z2HWMmTCJvlHAWL4fPkxvAT1sefqNsN2irDvJnJPdccw1CfYGg9A1lE0McyYV1Ocdht0dYV95HKpOfbDfNFh5w/+fzjhOdvB2zXSzRVgYr7O+MvEsriCHHoo8hSJFHA79pQiizBejGXB+JwAkIs/LlRnBY2KE35Xovjfovn44EX3siz+80Ki7aRBQR1mSOlIWjgQfEdU1ac8m58h0BXNfw6BFgVBvfTk5+15JcFq+4Luqbicf1OgypnELZR35UfqejcF3v0Gebo7ovANrS78br4AE1q71Ef9+veP9sYSVVY6GCY7OHGMzk+URhgOHiCOhxA46g8diwiOxVdJOF9xMRURJ4jVdwTEyJe+xcu3keZfozVdQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"sharedScriptSuiteRegistry yes filter\"\n        title=\"sharedScriptSuiteRegistry yes filter\"\n        src=\"/static/d3c22eefa59f8ba3aa2db53a76440dd8/d9199/profiler-inputfilter.png\"\n        srcset=\"/static/d3c22eefa59f8ba3aa2db53a76440dd8/8ff5a/profiler-inputfilter.png 240w,\n/static/d3c22eefa59f8ba3aa2db53a76440dd8/e85cb/profiler-inputfilter.png 480w,\n/static/d3c22eefa59f8ba3aa2db53a76440dd8/d9199/profiler-inputfilter.png 960w,\n/static/d3c22eefa59f8ba3aa2db53a76440dd8/07a9c/profiler-inputfilter.png 1440w,\n/static/d3c22eefa59f8ba3aa2db53a76440dd8/b1ffc/profiler-inputfilter.png 1492w\"\n        sizes=\"(max-width: 960px) 100vw, 960px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>which totally doesn't make sense to me. (It definitely has nothing whatsoever to do with the call being selected; you can see in both screenshots that the <code>sharedScriptSuitRegistry</code> call is selected.)</p>\n<h4>5. Another small complaint</h4>\n<p>which is deemed unimportant by the four items I mentioned previously:</p>\n<p>Can I get a \"expand all / collapse all\" button?</p>","timeToRead":4,"frontmatter":{"title":"My Journey with Xcode Instrument's Time Profiler","date":"May 10, 2023"}}},"pageContext":{"slug":"/posts/time-profiler/","prev":{"slug":"/posts/tofu-60-v2/","title":"机械键盘果然是个坑"},"next":{"slug":"/posts/wechat-apple/","title":"微信和苹果"}}},"staticQueryHashes":["320962347","63159454"]}